<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css" />

    <!-- 高德安全密钥（必须在API前） -->
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: "eccf45812b483258d1c6a8902532155a"
        };
    </script>

    <!-- 高德 API -->
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=3b38af595b172794e9fe2099fbef8a02&plugin=AMap.Driving,AMap.Autocomplete"></script>
    <script src="https://cache.amap.com/lbs/static/addToolbar.js"></script>

    <!-- Qt 通信文件（qwebchannel.js） -->
    <script src="qrc:/qwebchannel.js"></script>

    <style>
        #container {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <script>
        /*************** 初始化地图 ***************/
        var map = new AMap.Map("container", {
            resizeEnable: true,
            center: [116.397428, 39.90923],
            zoom: 13
        });

        var driving = new AMap.Driving({
            map: map,
            showTraffic: true,
            policy: AMap.DrivingPolicy.LEAST_TIME,
            extensions: "all"
        });

        var autoComplete = new AMap.Autocomplete({
            city: "北京"
        });

        var mchannel = null;

        /**************** Qt WebChannel 连接 ****************/
        window.onload = function () {
            if (typeof qt !== "undefined") {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    mchannel = channel;

                    const obj = channel.objects.qtChannel;
                    obj.cityChanged.connect(testSetCity);
                    obj.inputChanged_1.connect(dealComplete_1);
                    obj.inputChanged_2.connect(dealComplete_2);
                    obj.startlocation.connect(_startlocation);
                    obj.endlocation.connect(_endlocation);
                    obj.selectRoute.connect(setRoute);

                    getCurCity();
                });
            } else {
                console.log("Qt WebChannel not found.");
            }
        };


        /*************** 城市功能 ***************/
        function getCurCity() {
            map.getCity(function (place) {
                var city = place.city || place.province;
                autoComplete.setCity(city);
                mchannel.objects.qtChannel.cityChangeResult(city);
            });
        }

        function testSetCity(city) {
            map.setCity(city, function () {
                getCurCity();
            });
        }


        /*************** 自动补全 ***************/
        function dealComplete_1(cont) {
            autoComplete.search(cont, function (status, result) {
                mchannel.objects.qtChannel.getAutocomplete_1(result);
            });
        }

        function dealComplete_2(cont) {
            autoComplete.search(cont, function (status, result) {
                mchannel.objects.qtChannel.getAutocomplete_2(result);
            });
        }


        /*************** 导航标记 ***************/
        var startIcon = new AMap.Icon({
            size: new AMap.Size(25, 34),
            image: "http://a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png",
            imageSize: new AMap.Size(135, 40),
            imageOffset: new AMap.Pixel(-9, -3)
        });

        var endIcon = new AMap.Icon({
            size: new AMap.Size(25, 34),
            image: "http://a.amap.com/jsapi_demos/static/demo-center/icons/dir-marker.png",
            imageSize: new AMap.Size(135, 40),
            imageOffset: new AMap.Pixel(-95, -3)
        });

        var startMarker = null;
        var endMarker = null;

        function _startlocation(location) {
            const [lng, lat] = location.split(",").map(Number);
            const pos = new AMap.LngLat(lng, lat);

            if (!startMarker) {
                startMarker = new AMap.Marker({
                    position: pos,
                    icon: startIcon,
                    map: map
                });
            } else {
                startMarker.setPosition(pos);
            }

            map.setCenter(pos);
        }

        function _endlocation(location) {
            const [lng, lat] = location.split(",").map(Number);
            const pos = new AMap.LngLat(lng, lat);

            if (!endMarker) {
                endMarker = new AMap.Marker({
                    position: pos,
                    icon: endIcon,
                    map: map
                });
            } else {
                endMarker.setPosition(pos);
            }

            map.setCenter(pos);
        }


        /*************** 导航路线 ***************/
        function setRoute() {
            if (!startMarker || !endMarker) return;

            driving.search(startMarker.getPosition(), endMarker.getPosition(), function (status, result) {
                if (status === "complete") {
                    console.log("路线绘制完成");
                } else {
                    console.log("导航失败", result);
                }
            });
        }
    </script>

</body>

</html>
